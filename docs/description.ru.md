# description

Доступно на других языках: [English/Английский](description.md), [Russian/Русский](description.ru.md).

## Пошаговое описание работы клиентского приложения и сервиса 

### Регистрация 

1. Пользователь открывает приложение и выбирает "Зарегистрироваться". 
2. Пользователь вводит логин, email, телефон и пароль (пароль вводится дважды).
    - На форме производится валидация введенных значений.
    - Если **валидация не прошла**, то высвечивается сообщение об ошибке (остаемся на форме и даем пользователю возможность ввести данные ещё раз).
    - Если **валидация прошла**, то на сервис аутентификации отправляется **запрос на проверку существования пользователя** в БД (логин, email, телефон).
        - Поскольку пользователи не хранятся на сервисе аутентификации, то запрос должен быть переслан на бэкенд сервис, который хранит пользовательскую информацию.
    - Если **логин не существует** в БД, то на сервис аутентификации отправляется **запрос на добавление пользователя** в БД, сервис возвращает информацию по созданному пользователю (флаг создания пользователя, код верификации, дата/время создания кода верификации).
    - Если **логин существует**, то высвечивется сообщение "К сожалению, пользователь с таким именем уже существует. Пожалуйста, попробуйте снова".
    - **Опционально** (исполняется только в случае необходимости на уровне бизнес-логики клиентского приложения): Если **email** и/или **телефон существует**, то высвечивается сообщение "Пользователь с таким email и/или номером телефона уже существет. Из соображений безопасности данных, деактивируйте предыдущую учетную запись либо попробуйте вспомнить пароль к предыдущему аккаунту" и выбор "Вспомнить пароль"/"Деактивировать старую запись"/"Отмена".
        - Если пользователь нажимает "Вспомнить пароль", то он перенаправляется в форму входа в приложение.
        - Если пользователь нажимает "Деактивировать старую запись", то пользователь на новой форме вводит email или номер телефона, нажимает "Получить код деактивации", на сервис аутентификации отправляется запрос, сервис делает запись в таблице "Деактивация" и в ответ отправляет код деактивации, пользователь подтверждает или не подтверждает (см. пункт 4). Если подтверждает, то клентское приложение отправляет запрос на деактивацию, и тогда все активные записи в таблицах пользователей и токенов помечаются как устаревшие и перезаписанными.
    - Все изменения на данном этапе заносятся в таблицу "Регистрация".
<!--
    - Если во временной таблице несколько незакрытых попыток регистрации в течение дня с одинаковыми логином/email/телефоном, то вероятно, что пользователя пытаются взломать, поэтому после n-го раза в сообщении должно быть упоминание, что это последний раз за день.
-->
3. При добавлении пользователя на указанный email/телефон отправляется код верификации.
    - На стороне сервиса аутентификации работает джоба, которая отмечает записи в таблице "Регистрация".
4. Пользователь вводит код подтверждения.
    - Введенный код сравнивается с кодом подтверждения из сервиса.
    - На ввод кода подтверждения дается 3-5 попыток и 15-30 минут.
    - Код подтверждения хранится на форме.
        - Если пользователь **закрыл приложение**, то GUID регистрации теряется, поэтому даже если пользователь **после закрытия заходит снова** в приложение, то он попадает на форму регистрации и повторяет все действия снова (старая попытка должна быть перезаписывана на этапе 1).
    - Если пользователь **не смог подтвердить код** за установленное **количество попыток и/или минут**, оставаясь на форме, то на сервис отправляется запрос, чтобы **пометить запись для пользователя устаревшей** и **записать количество попыток**, и после этого пользователь перенаправляется на форму регистрации.
    - Если пользователь **отменил ввод**, то **отправить запрос** на сервис, чтобы **поставить код закрытия** в БД как "отменен".
    - Если пользователь **подтвердил код**, то **отправляем запрос** на сервис аутетентификации, чтобы **поставить код закрытия** регистрации как "успех".
5. Пользователь вовращается в форму входа в приложение (ввода логина).

### Вход в приложение 

1. Пользователь открывает приложение и выбирает "Войти". 
2. Пользователь вводит логин и пароль.
    - На форме производится валидация введенных значений.
    - Если **валидация не прошла**, то высвечивается сообщение об ошибке (остаемся на форме и даем пользователю возможность ввести данные ещё раз).
    - Если **валидация прошла**, то на сервис аутентификации отправляется **запрос на верификацию пользователя** (логин, пароль).
    - Если **пользователь не верифицирован**, то отображаем сообщение об ошибке "Неверный логин или пароль. Пожалуйста, пробуйте ещё раз".
    - Если **пользователь верифицирован**, то на сервис аутентификации отправляется **запрос на получение сессонного токена**.
        - Если при отправке сессионного токена кленту выясняется, что токен просрочен, то у него должна быть обновлена дата окончания.
3. Пользователь попадает в приложение.

## Методы для обработки сетевых запросов

### Регистрация 

- **Check user existance** - проверка наличия пользователя в БД (наименование: `CheckUserExistance`):
    - input: `UserCredentials`;
    - output: `UserExistance`.
- **Add user** - добавление пользователя (наименование: `AddUser`):
    - input: `UserCredentials`;
    - output: `UserCreationResult`.
- **Verify sign up** - верификация завершения регистрации (наименование: `VerifySignUp`):
    - input: `VSURequest`;
    - output: `VSUResponse`.
- **Get deacitvation code** - получение кода деактивации (наименование: `GetDeactivationCode`):
    - input: `UserCredentials`; 
    - output: `DeactivationCode`.
- **Deactivate users** - деактивация пользователей (наименование: `DeactivateUsers`): 
    - input: `DeactivationRequest`;
    - output: `DeactivationResponse`.

### Вход в приложение 

- **Verify user credentials** - верификация пользователя (наименование: `VerifyUserCredentials`)
    - input: `UserCredentials`;
    - output: `VUCResponse`.
- **Get token by user UID** - обновление сессионного токена по UID пользователя (наименование: `GetTokenByUserUid`)
    - input: `TokenRequest`; 
    - output: `SessionToken`.

### JSON объекты для межсетевого взаимодействия 

- **User credentials** - пользовательские данные (наименование: `UserCredentials`): 
    - `Login: string`, 
    - `Email: string`, 
    - `PhoneNumber: string`, 
    - `Password: string`.
- **User existance** - объект наличия пользователя по введенным данным (наименование: `UserExistance`): 
    - `LoginExists: bool`, 
    - `EmailExists: bool`, 
    - `PhoneNumberExists: bool`, 
    - `ExceptionMessage: string`.
- **User creation result** - результат добавления пользователя в БД (наименование: `UserCreationResult`):
    - `IsUserAdded: bool`,
    - `SignUpGuid: string`, 
    - `VerificationCode: string`, 
    - `CodeSendingDt: DateTime`, 
    - `ExceptionMessage: string`.
- **Verify sign up request** - запрос на подтверждение регистрации с помощью верификационного кода (наименование: `VSURequest`): 
    - `SignUpGuid: string`, 
    - `TriesNumber: int`, 
    - `IsDeprecated: bool`, 
    - `IsOverriden: bool`, 
    - `SignUpClosingCode: string`.
- **Verify sign up response** - ответ на подтверждение регистрации с помощью верификационного кода (наименование: `VSUResponse`):
    - `IsSuccessful: bool`, 
    - `ExceptionMessage: string`.
- **Verifying user credentials response** - ответ на верификацию пользовательских данных при вводе логина (наименование: `VUCResponse`):
    - `IsVerified: bool`, 
    - `UserUid: string`, 
    - `ExceptionMessage: string`.
- **Token request** - запрос на получение сессионного токена для пользователя (наименование: `TokenRequest`):
    - `UserUid: string`.
- **Session token** - сессионный токен (наименование: `SessionToken`):
    - `TokenGuid: string`, 
    - `TokenBeginDt: DateTime`,
    - `TokenEndDt: DateTime`,
    - overriden tokens,
    - `ExceptionMessage: string`.
- **Deactivation code** - ответ на запрос деактивационного кода (наименование: `DeactivationCode`):
    - `DeactivationGuid: string`, 
    - `Code: string`, 
    - `CodeSendingDt: DateTime`, 
    - `ExceptionMessage: string`.
- **Deactivation request** - запрос деактивации (наименование: `DeactivationRequest`):
    - `DeactivationGuid: string`.
- **Deactivation response** - результат деактивации (наименование: `DeactivationResponse`):
    - `IsSuccessful: bool`, 
    - `ExceptionMessage: string`.

## Хранение и обработка данных 

### Таблицы в БД 

- **Session token** - сессионный токен (наименование: `session_token`):
    - `session_token_id: integer` - ИД токена,
    - `token_guid: varchar` - сгенерированный GUID токена, 
    - `token_begin_dt: timestamp` - начало действия токена, 
    - `token_end_dt: timestamp` - окончание действия токена, 
    - `user_guid: varchar` - GUID пользователя (сам пользователь и его персональные данные не хранятся на стороне сервиса).
- **Sign up** - регистрация (наименование: `signup`): 
    - `signup_id: integer` - ИД регистрации,
    - `signup_guid: integer` - GUID регистрации,
    - `user_guid: varchar` - GUID созданного пользователя,
    - `token_guid` - сгенерированный GUID токена,
    - `token_begin_dt: timestamp` - начало действия токена,
    - `token_end_dt: timestamp` - окончание действия токена,
    - `verification_code: varchar` - код подтверждения регистрации,
    - `vc_sending_dt: timestamp` - время отправки кода подтверждения,
    - `tries_number: integer` - количество попыток ввода кода регистрации,
    - `signup_begin_dt: timestamp` - начало регистрации,
    - `signup_end_dt: timestamp` - конец регистрации,
    - `is_deprecated: boolean` - признак "устаревшая регистрация",
    - `is_overriden: boolean` - признак "перезаписанная регистрация",
    - `signup_closing_code_id`: код закрытия регистрации.
- **Suspicious sign up** - подозрительная регистрация (наименование: `suspicios_signup`): 
    - повторяет поля таблицы `signup`.
- **Sign up closing code** - код закрытия регистрации (наименование: `signup_closing_code`):
    - Поля: 
        - `signup_closing_code_id: integer` - ИД кода закрытия регистрации,
        - `guid: string` - UID кода закрытия регистрации,
        - `name: string`- наименование.
    - Возможные значения:
        - `success` - успех,
        - `rejectedToProvideVC` - отказ в предоставлении кода подтверждения,
        - `tooManyTries` - исчерпано количество попыток подтверждения кода,
        - `timeout` - отвалился по таймауту,
        - `overriden` - перезаписан,
        - `cancelled` - отмена.
- **Deactivation** - деактивация (наименование: `deactivation`):
    - `deactivation_id` - ИД деактивации,
    - `deactivation_uid` - UID деактивации,
    - `deactivation_code: varchar` - код деактивации,
    - `dc_sending_dt: timestamp` - время отправки кода подтверждения,
    - `deactivation_begin_dt: timestamp` - начало деактивации,
    - `deactivation_end_dt: timestamp` - конец деактивации,
    - `tries_number: integer` - количество попыток ввода кода деактивации,
    - `is_deprecated: boolean` - признак "устаревшая деактивация",
    - `is_overriden: boolean` - признак "перезаписанная деактивация",
    - `deactivation_closing_code_id`: код закрытия деактивации.
- **Deactivation-user** - деактивация-пользователь (наименование: `deactivation_user`):
    - `deactivation_id` - ИД деактивации,
    - `user_guid: varchar` - GUID существующего пользователя.

### Джобы

- Пометка записей в таблице проверки кода регистрации на клиентском приложении как устаревшие и перемещение на сервис (каждые 15-30 минут): если время отправки запроса было раньше продолжительности перепроверки и не закрыта.
- Копирование подозрительных записей из регистрации в таблицу с подозрительной регистрацией (1 раз в сутки): если было N и более не закрытых как успешных.
- Удаление устаревших записей из проверки кода регистрации на клиентском приложении и регистрации на сервисе (1-7 раз в неделю).
